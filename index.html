<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flizzy Bird ‚Äî Diperbaiki</title>
  <style>
    :root {
      --bg: #0b1026;
      --panel: rgba(255,255,255,.9);
      --ink: #111;
      --accent: #20c997;
      --danger: #ef4444;
      --muted: rgba(0,0,0,.6);
      --badge: rgba(0,0,0,.5);
      --chip: rgba(255,255,255,.2);
      --radius: 14px;
      /* --- Warna Tema --- */
      --sky-top: #74c0fc;
      --sky-bottom: #e7f5ff;
      --ground: #a68b5b;
      --grass: #37b24d;
      --pipe: #37b24d;
      --pipe-lip: #2b8a3e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: var(--bg);
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
      transition: background .4s ease;
    }
    .wrap {
      position: relative;
      width: min(560px, 100vw);
      height: 100dvh; /* <<<===== PERUBAHAN DI SINI */
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom);
    }

    /* HUD */
    .hud {
      position: absolute;
      top: 10px; left: 12px; right: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 3;
      pointer-events: none;
    }
    .badges {
      display: inline-flex; gap: 8px;
      pointer-events: auto;
    }
    .badge, .badge-btn {
      background: var(--badge);
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 14px;
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 10px rgba(0,0,0,.25);
      user-select: none;
      border: none;
      font-family: inherit;
      cursor: pointer;
    }
    .badge .val { font-variant-numeric: tabular-nums; margin-left: 6px; }

    .controls {
      position: absolute;
      right: 12px; bottom: 14px; left: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      z-index: 3;
    }
    button, select {
      pointer-events: auto;
      -webkit-user-select: none; user-select: none;
      appearance: none;
      border: none;
      background: var(--panel);
      color: var(--ink);
      font-weight: 700;
      font-size: 15px;
      padding: 12px 14px;
      border-radius: var(--radius);
      box-shadow: 0 6px 20px rgba(0,0,0,.22);
      cursor: pointer;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: #fff; }
    .btn-danger { background: #fff3f3; color: #991b1b; }
    .btn-sound.on { outline: 2px solid var(--accent); }

    .modebar {
      position: absolute; top: 52px; left: 12px;
      display: inline-flex; gap: 8px; align-items: center;
      z-index: 3; pointer-events: auto;
      background: var(--chip);
      color: #fff; backdrop-filter: blur(6px);
      padding: 6px 10px; border-radius: 999px;
    }
    .modebar label { font-size: 13px; opacity: .9; margin-right: 4px; }
    .modebar select { background: rgba(255,255,255,.9); padding: 6px 8px; border-radius: 10px; font-weight: 700; }

    /* Canvas */
    #game {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }

    /* Overlay */
    .overlay {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      z-index: 2; pointer-events: none;
    }
    .overlay .panel {
      text-align: center;
      background: rgba(255,255,255,.85);
      padding: 18px 22px;
      border-radius: 16px;
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
      max-width: min(92vw, 520px);
      width: 280px;
    }
    .overlay h1 { margin: 0 0 10px; font-size: 24px; }
    .overlay p { margin: 4px 0; color: #333; }
    .overlay small { color: #555; display: block; margin-top: 12px; }
    
    /* Papan Skor di Overlay */
    #ov-scoreboard { text-align: left; font-size: 16px; font-weight: 600; line-height: 1.8; }
    #ov-scoreboard div { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,.1); padding: 2px 0;}
    #ov-scoreboard span { font-weight: 700; color: var(--accent); }
    #ov-scoreboard .best { color: #ff922b; }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div class="badges">
        <div class="badge">Skor <span id="score" class="val">0</span></div>
        <div class="badge">Rekor <span id="best" class="val">0</span></div>
      </div>
       <button id="btnTheme" class="badge-btn">‚òÄÔ∏è Siang</button>
    </div>

    <div class="modebar">
      <label for="modeSel">Mode:</label>
      <select id="modeSel" aria-label="Pilih Mode">
        <option value="Mudah">Mudah</option>
        <option value="Normal" selected>Normal</option>
        <option value="Susah">Susah</option>
      </select>
    </div>

    <canvas id="game" width="480" height="800" aria-label="Game Flizzy Bird"></canvas>

    <div id="overlay" class="overlay">
      <div class="panel">
        <h1 id="ov-title">Flizzy Bird</h1>
        <div id="ov-scoreboard" class="hidden">
          <div>SKOR AKHIR: <span id="ov-score">0</span></div>
          <div>REKOR BARU: <span id="ov-best" class="best">0</span></div>
        </div>
        <p id="ov-msg">Tap/Klik/Spasi untuk kepak. Hindari pipa!</p>
        <small id="ov-small">Gunakan tombol di bawah untuk kontrol.</small>
      </div>
    </div>

    <div class="controls">
      <button id="btnToggle" class="btn-primary">Mulai</button>
      <button id="btnRestart" class="btn-danger">Reset</button>
      <button id="btnSound" class="btn-sound">Suara: On</button>
    </div>
  </div>

  <script>
  ;(() => {
    'use strict'

    // ====== World & Canvas ======
    const WORLD_W = 480, WORLD_H = 800
    const GROUND_H = 96
    const GROUND_Y = WORLD_H - GROUND_H

    const canvas = document.getElementById('game')
    const ctx = canvas.getContext('2d')

    // Hi-DPI rendering
    function setupHiDPI() {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1))
      canvas.width = Math.floor(WORLD_W * dpr)
      canvas.height = Math.floor(WORLD_H * dpr)
      canvas.style.aspectRatio = `${WORLD_W}/${WORLD_H}`
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
    }
    setupHiDPI()
    window.addEventListener('resize', setupHiDPI)

    // ====== UI Elements ======
    const elScore = document.getElementById('score')
    const elBest  = document.getElementById('best')
    const selMode = document.getElementById('modeSel')
    const btnToggle = document.getElementById('btnToggle')
    const btnRestart = document.getElementById('btnRestart')
    const btnSound = document.getElementById('btnSound')
    const btnTheme = document.getElementById('btnTheme')
    const overlay = document.getElementById('overlay')
    const ovTitle = document.getElementById('ov-title')
    const ovMsg = document.getElementById('ov-msg')
    const ovSmall = document.getElementById('ov-small')
    const ovScoreboard = document.getElementById('ov-scoreboard')
    const ovScore = document.getElementById('ov-score')
    const ovBest = document.getElementById('ov-best')

    // ====== Settings & Persistence ======
    const LS_BEST = 'bfb_highscore'
    const LS_SOUND = 'bfb_sound'
    const LS_THEME = 'bfb_theme'
    const settings = {
      sound: (localStorage.getItem(LS_SOUND) ?? 'on') === 'on',
      theme: localStorage.getItem(LS_THEME) || 'day'
    }

    function updateSoundButton() {
      btnSound.textContent = `Suara: ${settings.sound ? 'On' : 'Off'}`
      btnSound.classList.toggle('on', settings.sound)
    }
    
    function applyTheme() {
        const root = document.documentElement;
        if (settings.theme === 'night') {
            btnTheme.innerHTML = 'üåô Malam';
            root.style.setProperty('--bg', '#0b1026');
            root.style.setProperty('--sky-top', '#0d1a38');
            root.style.setProperty('--sky-bottom', '#212a4f');
            root.style.setProperty('--ground', '#594a2d');
            root.style.setProperty('--grass', '#2f6b38');
            root.style.setProperty('--pipe', '#2f6b38');
            root.style.setProperty('--pipe-lip', '#214d27');
        } else { // day
            btnTheme.innerHTML = '‚òÄÔ∏è Siang';
            root.style.setProperty('--bg', '#0b1026'); // Sama, agar transisi bagus
            root.style.setProperty('--sky-top', '#74c0fc');
            root.style.setProperty('--sky-bottom', '#e7f5ff');
            root.style.setProperty('--ground', '#a68b5b');
            root.style.setProperty('--grass', '#37b24d');
            root.style.setProperty('--pipe', '#37b24d');
            root.style.setProperty('--pipe-lip', '#2b8a3e');
        }
    }
    updateSoundButton();
    applyTheme();

    let best = Number(localStorage.getItem(LS_BEST) || 0)
    elBest.textContent = best

    // ====== Modes ======
    const MODES = {
      'Mudah':   { gravity: 1600, flap: 500, speed: 180, gap: 180, spawnMs: 1400 },
      'Normal':  { gravity: 1900, flap: 430, speed: 210, gap: 150, spawnMs: 1200 },
      'Susah':   { gravity: 2200, flap: 420, speed: 240, gap: 130, spawnMs: 1000 },
    }
    let mode = 'Normal'
    let P = MODES[mode]

    // ====== Game State ======
    let state = 'menu' // 'menu' | 'running' | 'paused' | 'over'
    let score = 0
    let lastT = performance.now()
    let spawnTimer = 0

    // Bird
    const bird = { x: 140, y: WORLD_H/2, r: 18, vy: 0, flapTick: 0 }
    
    // Pipes & Scenery
    const pipes = []
    const clouds = []
    const stars = []

    function spawnCloud(count) {
      clouds.length = 0;
      for (let i=0; i<count; i++) {
        clouds.push({
          x: Math.random() * WORLD_W,
          y: randRange(60, 350),
          r: randRange(25, 60),
          v: randRange(10, 25)
        })
      }
    }
    function spawnStars(count) {
        stars.length = 0;
        for (let i=0; i<count; i++) {
            stars.push({
                x: Math.random() * WORLD_W,
                y: Math.random() * (GROUND_Y - 50),
                r: randRange(0.5, 2)
            });
        }
    }
    spawnCloud(8);
    spawnStars(80);

    // ====== Audio (WebAudio) ======
    let audioCtx = null
    function ensureAudioCtx() {
      if (!settings.sound) return null
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext
        if (!AC) return null
        try { audioCtx = new AC() } catch(e) { audioCtx = null }
      }
      return audioCtx
    }
    function sfx(type) {
      const ctxA = ensureAudioCtx()
      if (!ctxA) return
      const o = ctxA.createOscillator()
      const g = ctxA.createGain()
      o.connect(g); g.connect(ctxA.destination)
      const now = ctxA.currentTime
      if (type==='flap') {
        o.type='square'; o.frequency.setValueAtTime(600, now)
        o.frequency.exponentialRampToValueAtTime(300, now+0.1)
        g.gain.setValueAtTime(0.12, now)
        g.gain.exponentialRampToValueAtTime(0.001, now+0.12)
        o.start(now); o.stop(now+0.15)
      } else if (type==='score') {
        o.type='triangle'; o.frequency.setValueAtTime(820, now)
        o.frequency.linearRampToValueAtTime(1180, now+0.08)
        g.gain.setValueAtTime(0.08, now)
        g.gain.exponentialRampToValueAtTime(0.001, now+0.12)
        o.start(now); o.stop(now+0.14)
      } else if (type==='over') {
        o.type='sawtooth'; o.frequency.setValueAtTime(200, now)
        g.gain.setValueAtTime(0.16, now)
        g.gain.exponentialRampToValueAtTime(0.001, now+0.4)
        o.start(now); o.stop(now+0.45)
      }
    }

    // Speech
    function say(text) {
      if (!settings.sound) return
      if (!('speechSynthesis' in window)) return
      window.speechSynthesis.cancel(); // Hentikan ucapan sebelumnya
      const u = new SpeechSynthesisUtterance(text)
      u.lang = 'id-ID'
      u.rate = 1.05
      u.pitch = 1.1
      window.speechSynthesis.speak(u)
    }

    // ====== Helpers ======
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)) }
    function randRange(a,b){ return a + Math.random()*(b-a) }
    function circleRectColl(cx, cy, r, rx, ry, rw, rh) {
      const nx = clamp(cx, rx, rx + rw)
      const ny = clamp(cy, ry, ry + rh)
      const dx = cx - nx, dy = cy - ny
      return (dx*dx + dy*dy) < r*r
    }

    // ====== Game Core ======
    function resetRound() {
      score = 0
      elScore.textContent = score
      pipes.length = 0
      spawnTimer = 0
      bird.y = WORLD_H/2
      bird.vy = 0
      bird.flapTick = 0
    }

    function startGame() {
      resetRound()
      setState('running')
    }

    function setState(ns) {
      state = ns
      overlay.classList.add('hidden');
      ovScoreboard.classList.add('hidden');
      ovMsg.classList.remove('hidden');
      ovSmall.classList.remove('hidden');

      if (state === 'running') {
        btnToggle.textContent = 'Jeda'
      } else if (state === 'paused') {
        ovTitle.textContent = 'Jeda'
        ovMsg.textContent = 'Tap/Klik/Spasi untuk lanjut.'
        ovSmall.textContent = 'Hindari pipa!'
        overlay.classList.remove('hidden')
        btnToggle.textContent = 'Lanjut'
      } else if (state === 'over') {
        ovTitle.textContent = 'Game Over'
        ovScore.textContent = score;
        ovBest.textContent = best;
        ovScoreboard.classList.remove('hidden');
        ovMsg.classList.add('hidden');
        ovSmall.textContent = `Klik 'Coba Lagi' untuk mengulang.`
        overlay.classList.remove('hidden')
        btnToggle.textContent = 'Coba Lagi'
      } else { // menu
        ovTitle.textContent = 'Flizzy Bird'
        ovMsg.textContent = 'Tap/Klik/Spasi untuk kepak. Hindari pipa!'
        ovSmall.textContent = 'Gunakan tombol di bawah untuk kontrol.'
        overlay.classList.remove('hidden')
        btnToggle.textContent = 'Mulai'
      }
    }

    function gameOver() {
      sfx('over')
      if (score > best) {
        best = score
        localStorage.setItem(LS_BEST, String(best))
        elBest.textContent = best
        say(`Rekor baru! ${score} poin!`);
      } else {
        say(`Game over! Skor kamu ${score}.`);
      }
      setState('over')
    }

    function spawnPipe() {
      const w = 72
      const gapH = P.gap
      const centerY = randRange(180, GROUND_Y - 120)
      const topH = clamp(centerY - gapH/2, 40, GROUND_Y - gapH - 40)
      pipes.push({ x: WORLD_W + 10, w, topH, gapH, passed: false })
    }

    function update(dt) {
      // Scenery
      if(settings.theme === 'day') {
        for (const c of clouds) { c.x -= c.v * dt; if (c.x < -c.r*2) c.x = WORLD_W + c.r*2 }
      }

      // Spawn pipes
      spawnTimer += dt * 1000
      while (spawnTimer >= P.spawnMs) {
        spawnPipe()
        spawnTimer -= P.spawnMs
      }

      // Move pipes & scoring
      for (const p of pipes) {
        p.x -= P.speed * dt
        if (!p.passed && (p.x + p.w) < (bird.x - bird.r)) {
          p.passed = true
          score += 1
          elScore.textContent = score
          sfx('score')
          if (score && score % 10 === 0) say(`Mantap! Skor ${score}`)
        }
      }
      while (pipes.length && (pipes[0].x + pipes[0].w) < -20) pipes.shift()

      // Bird physics
      bird.vy += P.gravity * dt
      bird.y += bird.vy * dt
      bird.flapTick = Math.max(0, bird.flapTick - dt)

      // Ground collision
      if (bird.y + bird.r >= GROUND_Y) {
        bird.y = GROUND_Y - bird.r
        gameOver(); return
      }

      // Pipes collision
      for (const p of pipes) {
        const topRect = { x: p.x, y: 0, w: p.w, h: p.topH }
        const botY = p.topH + p.gapH
        const botRect = { x: p.x, y: botY, w: p.w, h: GROUND_Y - botY }
        if (circleRectColl(bird.x, bird.y, bird.r, topRect.x, topRect.y, topRect.w, topRect.h) ||
            circleRectColl(bird.x, bird.y, bird.r, botRect.x, botRect.y, botRect.w, botRect.h)) {
          gameOver(); return
        }
      }
    }

    // ====== Render ======
    function drawBg() {
      const g = ctx.createLinearGradient(0, 0, 0, WORLD_H)
      g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--sky-top'));
      g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--sky-bottom'));
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, WORLD_W, WORLD_H);

      if (settings.theme === 'night') {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        for(const s of stars) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
        }
        // Moon
        ctx.fillStyle = '#f5f3ce';
        ctx.beginPath();
        ctx.arc(WORLD_W - 80, 80, 40, 0, Math.PI*2);
        ctx.fill();
      } else { // Day
        ctx.globalAlpha = 0.9;
        ctx.fillStyle = 'white';
        for (const c of clouds) {
            drawCloud(c.x, c.y, c.r)
        }
        ctx.globalAlpha = 1;
      }
      
      const groundColor = getComputedStyle(document.documentElement).getPropertyValue('--ground');
      const grassColor = getComputedStyle(document.documentElement).getPropertyValue('--grass');

      ctx.fillStyle = groundColor;
      ctx.fillRect(0, GROUND_Y, WORLD_W, GROUND_H);
      ctx.fillStyle = grassColor;
      ctx.fillRect(0, GROUND_Y - 10, WORLD_W, 12);
    }
    
    function drawCloud(x, y, r) {
      ctx.beginPath()
      ctx.arc(x, y, r, 0, Math.PI*2)
      ctx.arc(x + r*0.8, y + r*0.2, r*0.9, 0, Math.PI*2)
      ctx.arc(x - r*0.7, y + r*0.3, r*0.7, 0, Math.PI*2)
      ctx.fill()
    }

    function drawPipes() {
      const pipeColor = getComputedStyle(document.documentElement).getPropertyValue('--pipe');
      const pipeLipColor = getComputedStyle(document.documentElement).getPropertyValue('--pipe-lip');
      for (const p of pipes) {
        const x = p.x, w = p.w, topH = p.topH, gapH = p.gapH
        ctx.fillStyle = pipeColor
        ctx.fillRect(x, 0, w, topH)
        ctx.fillRect(x, topH + gapH, w, GROUND_Y - (topH + gapH))
        ctx.fillStyle = pipeLipColor
        ctx.fillRect(x-3, topH-14, w+6, 14)
        ctx.fillRect(x-3, topH + gapH, w+6, 14)
        ctx.fillStyle = 'rgba(255,255,255,.25)'
        ctx.fillRect(x+6, 0, 6, topH)
        ctx.fillRect(x+6, topH + gapH, 6, GROUND_Y - (topH + gapH))
      }
    }

    function drawBird() {
      const tilt = clamp(bird.vy / 600, -0.6, 0.8)
      ctx.save()
      ctx.translate(bird.x, bird.y)
      ctx.rotate(tilt)
      ctx.fillStyle = '#ffd43b';
      ctx.beginPath(); ctx.arc(0, 0, bird.r, 0, Math.PI*2); ctx.fill()
      ctx.fillStyle = '#fff3bf';
      ctx.beginPath(); ctx.arc(2, 4, bird.r*0.65, 0, Math.PI*2); ctx.fill()
      const wingUp = bird.flapTick > 0
      ctx.fillStyle = '#fab005'
      ctx.beginPath()
      const wy = wingUp ? -bird.r*0.4 : bird.r*0.2
      ctx.moveTo(-4, wy)
      ctx.lineTo(-bird.r*1.2, wy + (wingUp ? -10 : 10))
      ctx.lineTo(8, wy + (wingUp ? -4 : 6))
      ctx.closePath(); ctx.fill()
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.arc(bird.r*0.35, -bird.r*0.25, bird.r*0.35, 0, Math.PI*2); ctx.fill()
      ctx.fillStyle = '#111';
      ctx.beginPath(); ctx.arc(bird.r*0.48, -bird.r*0.25, bird.r*0.15, 0, Math.PI*2); ctx.fill()
      ctx.fillStyle = '#ff922b';
      ctx.beginPath()
      ctx.moveTo(bird.r*0.9, 0)
      ctx.lineTo(bird.r*1.5, bird.r*0.18)
      ctx.lineTo(bird.r*0.9, bird.r*0.32)
      ctx.closePath(); ctx.fill()
      ctx.restore()
    }

    function render() {
      drawBg()
      drawPipes()
      drawBird()
    }

    // ====== Input ======
    function doFlap() {
      if (state === 'over') return
      if (state === 'menu') {
        startGame()
      }
      if (state === 'paused') {
        setState('running')
      }
      if (state === 'running') {
        bird.vy = -P.flap
        bird.flapTick = 0.12
        sfx('flap')
      }
    }

    canvas.addEventListener('pointerdown', (e) => {
      e.preventDefault(); doFlap()
      ensureAudioCtx()?.resume?.()
    }, { passive: false })

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); doFlap(); ensureAudioCtx()?.resume?.() }
      if (e.code === 'KeyP') {
        if (state === 'running') setState('paused')
        else if (state === 'paused') setState('running')
      }
    })

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && state === 'running') setState('paused')
    })

    // Buttons
    btnToggle.addEventListener('click', () => {
      if (state === 'menu' || state === 'over') startGame()
      else if (state === 'running') setState('paused')
      else if (state === 'paused') setState('running')
      ensureAudioCtx()?.resume?.()
    })

    btnRestart.addEventListener('click', () => {
      resetRound(); setState('menu')
    })

    btnSound.addEventListener('click', () => {
      settings.sound = !settings.sound
      localStorage.setItem(LS_SOUND, settings.sound ? 'on' : 'off')
      updateSoundButton()
      if (settings.sound) { ensureAudioCtx()?.resume?.(); sfx('score') }
    })
    
    btnTheme.addEventListener('click', () => {
        settings.theme = settings.theme === 'day' ? 'night' : 'day';
        localStorage.setItem(LS_THEME, settings.theme);
        applyTheme();
    });

    selMode.addEventListener('change', () => {
      mode = selMode.value
      P = MODES[mode]
      // document.getElementById('modeLabel').textContent = mode; // Pastikan ada elemen ini jika ingin dipakai
      resetRound()
      setState('menu')
    })

    // ====== Main Loop ======
    function tick(t) {
      const dt = Math.min(0.033, (t - lastT) / 1000)
      lastT = t
      if (state === 'running') update(dt)
      render()
      requestAnimationFrame(tick)
    }
    requestAnimationFrame(tick)

    // Init
    setState('menu')
  })()
  </script>
</body>
</html>
